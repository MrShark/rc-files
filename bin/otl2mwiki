#!/usr/bin/env python
from optparse import OptionParser
from os.path import extsep
import sys

options = {}
def handle_cmdline():
    global options
    parser = OptionParser()
    parser.add_option("-l", "--start-level",
                          action="store", type="int", dest="startlevel", default=1,
                          help="at what level should the headers start")

    (options, args) = parser.parse_args()

    if len(args) == 0:
        args = ["-","-"]
    elif len(args) == 1:
        of=extsep.join(args[0].split(extsep)[:-1])+extsep+"mwiki"
        args = [args[0],of]
    elif len(args) >2:
        exit("please suply at most 2 arguments")
    
    if args[0] == "-":
        infile=sys.stdin
    else:
        infile=open(args[0])

    if args[1] == "-":
        outfile=sys.stdout
    else:
        outfile=open(args[1],"w")

    return (infile, outfile)

def parse(line):
    if line.lstrip("\t").startswith("|"):
        return line.lstrip("\t|").rstrip("\n")
    level = len(line)-len(line.lstrip("\t"))+options.startlevel
    return "\n" + "="*level + line.lstrip("\t|").rstrip("\n") + "="*level

def main():
    (inputfile, outputfile) = handle_cmdline()
    for line in inputfile:
        outputfile.write(parse(line)+"\n")

if __name__ == "__main__":
    main()
